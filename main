from cmu_graphics import *
import random, copy
from PIL import Image
import time

# basic background/framework of app + buttons

class Frame:
    # draws basic setup of drawing app
    def __init__(self, app):
        self.x = 0
        self.y = 0
        self.w = app.width
        self.h = app.height
        self.toolsW = self.w/5
        self.toolsH = app.height
        self.canvasW = self.w/5 
        self.canvasH = self.toolsH 
        self.color = rgb(112, 112, 112) # hehe
        self.border = 'black'
    
    def drawBg(self, app):
        # background of app
        drawRect(0, 0, app.width, app.height, 
                 fill=self.color) #background
    
    def drawToolBar(self, app):
        # tool bar and tools
        drawRect(0, 0, app.width/5+10, app.height, 
                 fill=self.color)
        drawLine(app.width/5, 0, app.width/5, app.height, fill='black')
        drawRect(app.width-app.width/5-10, 0, self.w, app.height,
                 fill=self.color)
        drawLine(app.width-app.width/5, 0, app.width-app.width/5, 
                 app.height, fill='black')

class Button:
    def __init__(self, x, y, width, color, border, height=None,
                 func=None, text=None):
        self.x = x
        self.y = y
        self.size = width
        self.color = color
        self.border = border
        self.ysize = height or self.size
        self.text = text
        self.func = func

    def drawButton(self):
        drawRect(self.x, self.y, self.size, self.ysize, 
                fill=self.color, border=self.border)
        self.drawText()

    def drawText(self):
        drawLabel(self.text, self.x+self.size/2, self.y+self.ysize/2, 
                  size=15, align='center')

    def drawIcon(self, image):
        # print('app pil list check', app.pilImages)
        # for image in app.pilImages:
        #     time.sleep(0.05)
        drawImage(image, self.x, self.y, align='left-top')
    
    def drawLayerControl(self):
        drawRect(self.x, self.y, self.size, self.ysize, 
                 fill=self.color, border=self.border)

    def drawLayerButton(self, layerCt, layerOpacity):
        y = app.width - self.y*5
        drawRect(self.x, y, self.size*2, self.ysize, 
                 fill=self.color, border=self.border)
        drawLabel(f'Layer {layerCt}', self.x+5, y, align='left-top')
        drawLabel(f'Opacity {layerOpacity}%', 
                  self.x+5, self.y+20, align='left-top')

    def isPressed(self, mX, mY):
        bRight = self.x + self.size
        bBottom = self.y + self.ysize
        if (self.x <= mX <= bRight and 
            self.y <= mY <= bBottom):
            return True
        return False
    
    def respondToPress(self, app, mX, mY):
        if self.isPressed(mX, mY): 
            return True
        return False
    
    def getFunc(self, app):
        return self.func

    def __eq__(self, other):
        if isinstance(other, Button):
            return (self.x == other.x and 
            self.y == other.y 
            and self.size == other.size)
    
    def __hash__(self):
        return hash((self.x, self.y, self.size))
    
class Canvas:
    # what you draw on, a white canvas
    def __init__(self, x, y, w, h, dx=0, dy=0, dsize=1, opacity=100):
        self.canvasLeft = x
        self.canvasTop = y
        self.canvasWidth = w
        self.canvasHeight = h
        self.opacity = opacity
        # self.opacity = 0  #test

    def drawCanvas(self, app, x, y, w, h, dx=0, dy=0, dsize=1):  
        self.canvasLeft = x + app.dx + 10
        self.canvasTop = y + app.dy + 10
        self.canvasWidth = w*app.dsize - 20
        self.canvasHeight = h*app.dsize - 10
        drawRect(self.canvasLeft, self.canvasTop, 
                 self.canvasWidth, self.canvasHeight, fill='white', 
                 opacity=self.opacity)
        
class Layer(Canvas):
    count = 0
    # puts all drawings into an instance of a layer, can stack layers 
    def __init__(self, app, x=0, y=0, w=0, h=0, dx=0, dy=0, dsize=1):
        super().__init__(x, y, w, h, dx, dy, dsize)
        Layer.count += 1
        self.count = Layer.count
        self.rectsList = []
        self.ovalsList = []
        self.straightLinesList = []
        self.opacity = 100
        self.pencilLinesList = [] # [[[color][points]]] format 
        self.pastelLinesList = []
        self.allItems = [
             [app.rect, self.rectsList, self.drawRects], 
             [app.oval, self.ovalsList, self.drawOvals],
             [app.straight, self.straightLinesList, 
                                self.drawStraightLines], 
             [app.pencil, self.pencilLinesList, self.drawPencilLines],
             [app.pastel, self.pastelLinesList, self.drawPastelLines]]
        self.redo = []
        self.lastMove = None

    def addOpacity(self):
        self.opacity += 10
    
    def deleteOpacity(self):
        self.opacity -= 10

    def getInfo(self, other): # gets the list the info needs to get added to
        for toggle, lst, func in self.allItems:
            if toggle == other:
                return lst
    
    def func(self, other):
        for toggle, lst, func in self.allItems:
            if toggle == other:
                return func

    def getLayerCtOp(self): # for labelling info about that layer
        return (Layer.count, self.opacity)

    def drawRects(self, ptList):
        if len(ptList[1]) < 3:
            return
        color = ptList[0]
        print('point list', ptList[1])
        (tl, tr), (bl, br) = ptList[1]
        w, h = abs(bl - tr), abs(br - tr)
        drawRect(tl, tr, w, h, fill=color, opacity=self.opacity)
        print('try find rect location', tl, tr, w, h, color)
    
    def drawOvals(self, ptList):
        if len(ptList[1]) < 3:
            return
        color = ptList[0]
        print('pts of Ovals', ptList)
        (tl, tr), (bl, br) = ptList[1]
        w, h = abs(bl - tr), abs(br - tr)
        drawOval(tl, tr, w, h, fill=color, opacity=self.opacity)
    
    def drawPastelLines(self, pointList, opacity=100):
        o = self.opacity
        if len(pointList) < 1:
            return
        color = pointList[0][0]
        pts = pointList[1]
        print('points coordinates', pts)
        for i in range(1, len(pts)-1):
            drawLine(pts[i-1][0], pts[i-1][1], 
                    pts[i][0], pts[i][1], lineWidth=6, 
                    fill=color, opacity=o-40)
            drawLine(pts[i-1][0], pts[i-1][1], 
                    pts[i][0], pts[i][1], lineWidth=12, 
                    fill=color, opacity=o-50)
            drawLine(pts[i-1][0], pts[i-1][1], 
                    pts[i][0], pts[i][1], lineWidth=18, 
                    fill=color, opacity=o-70)
            
    def drawPencilLines(self, pointList, opacity=100):
        o = self.opacity
        if len(pointList) < 1:
            return
        color = pointList[0][0]
        pts = pointList[1]
        for i in range(1, len(pts)):
            drawLine(pts[i-1][0], pts[i-1][1], 
                    pts[i][0], pts[i][1], fill=color, opacity=o)   

    def drawStraightLines(self, pointList, opacity=100):
        o = self.opacity
        if len(pointList) < 1:
            return
        color = pointList[0][0]
        pts = pointList[1]
        drawLine(pts[0][0], pts[0][1], pts[1][0], pts[1][1],
                fill=color, opacity=o) 

    def colorChanger(self, app):
        r = random.randrange(0, 256)
        g = random.randrange(0, 256)
        b = random.randrange(0, 256)
        app.currColor = rgb(r, g, b) 

    def erase(self, pointList):
        o = 100
        if len(pointList) < 1:
            return
        color = 'white' # ignore current color
        pts = pointList[1]
        for i in range(1, len(pts)):
            drawLine(pts[i-1][0], pts[i-1][1], 
                    pts[i][0], pts[i][1], fill=color, opacity=o) 

    def undo(self, app): # only works on current layer, list of type
        lst = getInfo(self, app.lastMove)
        undid = lst.pop()
        self.redo.append(undid)

    def redo(self, app):
        redid = self.redo.pop()
        lst = getInfo(self, app.lastMove)
        lst.append(redid) # assuming it's smthing like app.penciLinesList

    def drawOld(self):
        for toggle, itemList, func in self.allItems: 
            for item in itemList:
                func(item)

class globalLayer:
    def __init__(self):
        self.allLayers = []
    
    def addLayer(self, other):
        self.allLayers.append(other)
    
    def deleteLayer(self):
        delLayer = self.allLayers.pop()
                
def onAppStart(app):
    app.stepsPerSecond = 10
    app.slate = Frame(app) # initial background screen 
    startTools(app)
    app.startLayer = Layer(app)
    app.layers = globalLayer() # store all layers
    app.layers.addLayer(app.startLayer) 
    startLayerTools(app)
    app.new = [] # add this to layer's lists after

def startTools(app):
    app.canDraw = False
    app.finishDraw = False
    app.oval = [False]
    app.rect = [False]
    print('app.rect', app.rect)
    app.pastel = [False]
    app.pencil = [False]
    app.straight = [False]
    app.currColor = 'red'
    app.eraser = [False]
    app.undo = [False]
    app.redo = [False]
    # for panning: dx, dy
    app.dx = 0
    app.dy = 0
    # for zooming: zoomIn, zoomOut, dsize
    app.zoomIn = [False]
    app.zoomOut = [False]
    app.currentMove = None
    app.lastMove = None
    app.dsize = 1
    app.tools = [[app.pastel, app.pencil],
                 [app.oval, app.rect],
                 [app.straight, app.eraser], 
                 [app.undo, app.redo], 
                 [app.zoomIn, app.zoomOut]] # get rid of zoom
                # write a note that says that panning uses arrow keys 
                # also need a color selector
                # new layer
    startLeftTools(app)

def startLeftTools(app): # regular drawing tools
    app.buttons = [] # buttons to press to switch tools above
    start = app.width/30
    for row in range(5): 
        for col in range(2):
            button = Button(60*col+start, 60*row+20, 50, 
                            app.slate.color, app.slate.border)
            app.buttons.append([button, row, col])
    startIcons(app)

def startLayerTools(app): # layer tools
    app.layerCtOp = [] # specific info abt that layer, count and opacity
    app.layerControls = []
    start = app.width * 4 / 5
    width = app.width / 12
    height = 0.5 * width
    controls = ['+ layer', '- layer', '+ opacity', '- opacity']
    actions = [app.layers.addLayer, app.layers.deleteLayer,
               app.startLayer.addOpacity, app.startLayer.deleteOpacity]
    for i in range(len(controls)):
        m = 0
        if i % 2 == 0:
            m = 1
        x = width * m * (i % 2 + 1.1) + start + 10
        y = 20 + (i // 2 * width)
        control = Button(x, y, width,
                        app.slate.color, app.slate.border, height,
                        actions[i], controls[i])
        # 0 and 1 iff
        # 2 and 3 same x
        app.layerControls.append(control) 
    ct, opacity = 1, 100
    app.layerCtOp.append([ct, opacity])

def loadPilImage(path):
    return Image.open(path)
#app.img 

def startIcons(app):
    app.paths = ['images/pastel.jpg','images/pencil.jpg',
                'images/oval.jpg', 'images/rectangle.jpg',
                'images/line.jpg', 'images/eraser.jpg', 
                'images/undo.jpg', 'images/redo.jpg', 
                 'images/zoomIn.jpg', 'images/zoomOut.jpg'] # 10 icon images
    app.pilImages = []
    for path in app.paths:
        imagei = loadPilImage(path)
        imageWidth, imageHeight = imagei.size
        pilImage2 = imagei.resize((imageWidth//6, imageHeight//6))
        a = CMUImage(pilImage2)
        app.pilImages.append(a)

def onMousePress(app, mX, mY):
    # after clicking on a btton 
    # initialize that shape/line or layer
    # if button is draw pencil line, call Layer.pencilLines
    # wahtever color is selected
    app.new.append([app.currColor])
    app.new.append([])
    if mX <= app.width/5:
        for [button, row, col] in app.buttons:
            currButton = button
            if currButton.respondToPress(app, mX, mY): # call tools to activate 
                tool = app.tools[row][col]
                print('test app.tools[row][col]', app.tools[row][col])
                app.canDraw = True
                tool[0] = True
                print(app.tools)
                app.currentMove = tool
                app.canDraw = True
                print('currently doing what', app.currentMove)
                rows = len(app.tools)
                cols = len(app.tools[0])
                for row in range(rows):
                    for col in range(cols):
                        tool = app.tools[row][col]
                        if tool[0] == True:
                            print('which tool coordinates', row, col)
                            if app.tools[row][col] in [app.pencil, app.pastel, app.eraser,
                                                        app.oval, app.rect, app.straight]:
                                app.new[1].append((mX, mY))
                                print('start append?', app.new[1])
                            elif app.tools[row][col] in [app.redo, app.undo]:
                                app.startLayer.redo(app)
                                app.startLayer.undo(app)

            else:
                app.tools[row][col][0] = False
    elif mX >= app.width - app.width/5:
        button = app.layerControls[0] 
        currButton = button
        if currButton.respondToPress(app, mX, mY): # add layer pressed
            app.layers.addLayer(app.startLayer)
            app.startLayer = Layer(app)
        button = app.layerControls[1]
        currButton = button
        if currButton.respondToPress(app, mX, mY): # delete layer pressed
             if len(app.layers.allLayers) > 1:
                app.layers.deleteLayer()
        button = app.layerControls[2]
        currButton = button
        if currButton.respondToPress(app, mX, mY):
            app.startLayer.opacity = button.opacity 

def onMouseDrag(app, mX, mY):
    rows = len(app.tools)
    cols = len(app.tools[0])
    for row in range(rows):
        for col in range(cols):
            tool = app.tools[row][col]
            if tool[0] == True:
                if tool in [app.pencil, app.pastel, app.eraser]:
                    app.new[1].append((mX, mY))
        
def onMouseRelease(app, mX, mY):
    #add it to the list of items
    #  #  designated color is now the last itemin list
    rows = len(app.tools)
    cols = len(app.tools[0])
    for row in range(rows):
        for col in range(cols):
            tool = app.tools[row][col]
            if tool[0] == True and app.canDraw: 
                if tool in [app.oval, app.rect, app.straight]:
                    app.new[1].append((mX, mY))
                    print('point 2????', app.new)
                lstToAdd = app.startLayer.getInfo(tool)
                lstToAdd.append(app.new)
                app.new = []
                app.lastMove = app.currentMove 
                app.finishDraw = True

def onKeyPress(app, key):
    if key == 'left':
        app.dx += 5
    elif key == 'right':
        app.dx -= 5
    elif key == 'up':
        app.dy += 5
    elif key == 'down':
        app.dy -= 5
    print('pan key')

def redrawAll(app):
    #resizes app bar
    app.slate.drawBg(app) #draws very background of app
    startX = app.slate.canvasW
    endX = app.slate.w - startX*2
    #draw white background for first layer (default look)
    app.layers.allLayers[0].drawCanvas(app, startX, 0, endX, app.slate.h-10)
    app.slate.drawToolBar(app)
    drawLayerAllInfo(app)
    for i in range(len(app.buttons)): # regular tool buttons
        button = app.buttons[i]
        button[0].drawButton()
        button[0].drawIcon(app.pilImages[i])
        

def drawLayerAllInfo(app):
    for i in range(len(app.layerControls)): # layer add/del buttons
        button = app.layerControls[i]
        button.drawButton()
        button.drawText()
                    
    for i in range(len(app.layerCtOp)):
        ct = app.layerCtOp[i][0]
        opacity = app.layerCtOp[i][1]
        start = app.width*4.5/5
        top = app.width* 4 / 5
        w, h = 40, 20
        drawRect(start-app.width/5, top, w, h, 
                 fill=app.slate.color, border='black')
        drawLabel(f'layer {ct}', start, top+w/3, size=10)
        drawLabel(f'opacity {opacity}%', start, top+w/2, size=10)

    for layer in app.layers.allLayers: #app, draw current, color 
        for [toggle, lst, func] in layer.allItems:
            if toggle[0] == True and len(lst) >= 2:
                print('toggle test', toggle)
                func(lst)
        layer.drawOld() #2d list of points
    
runApp(width=800, height=600)